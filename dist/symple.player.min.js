!function(a){a.Media={engines:{},registerEngine:function(b){return a.log("symple:media: register media engine: ",b),b.name&&"undefined"!=typeof b.preference&&"undefined"!=typeof b.support?(this.engines[b.id]=b,!0):(a.log("symple:media: cannot register invalid engine",b),!1)},hasEngine:function(a){return"object"==typeof this.engines[a]},supportsEngine:function(a){return!(!this.hasEngine(a)||!this.engines[a].support)},supportsFormat:function(a){return!!preferredEngine(a)},compatibleEngines:function(){var b,c=[];for(var d in this.engines)b=this.engines[d],0!=b.preference&&(a.log("symple:media: supported",b.name,b.support),1==b.support&&c.push(b));return c.sort(function(a,b){return a.preference<b.preference?1:a.preference>b.preference?-1:void 0}),c},preferredCompatibleEngine:function(b){var c,d=this.compatibleEngines(b);return c=d.length?d[0]:null,a.log("symple:media: preferred engine",c),c},getOptimalVideoResolution:function(){var a=$(window).width(),b=a>800?800:a>640?640:a>480?400:a>320?320:a>240?240:a>160?160:a>128?128:96,c=.75*b;return[b,c]},buildURL:function(a){var b,c=[],d=a.address;b=d.scheme+"://"+d.host+":"+d.port+(d.uri?d.uri:"/");for(var e in a)"address"!=e&&c.push(encodeURIComponent(e)+"="+encodeURIComponent(a[e]));return c.push("rand="+Math.random()),b+="?",b+=c.join("&")},rescaleVideo:function(a,b,c,d){var e=c/d,f=1.33;return e>f?(b=d,a=b*f):(a=c,b=a/f),[a,b]},checkCandidate:function(b,c){a.log("symple:media: checking candidate: ",b);var d;if(window.XMLHttpRequest)d=new XMLHttpRequest;else{if(!window.ActiveXObject)return void c(b,!1);d=new ActiveXObject("Microsoft.XMLHTTP")}d.onreadystatechange=function(){2==d.readyState?c&&(a.log("symple:media: candidate result: ",d.readyState,d.status),c(b,200==d.status),c=null,setTimeout(function(){d.abort()},0)):4==d.readyState&&c&&(a.log("symple:media: candidate result: ",d.readyState,d.status),c(b,!0),c=null)},d.open("GET",b,!0),d.send(null)}},a.Player=a.Class.extend({init:function(b){if(this.options=a.extend({format:"MJPEG",engine:void 0,htmlRoot:"/javascripts/symple",element:".symple-player:first",fullscreenElement:void 0,onCommand:function(){},onStateChange:function(){},template:'                <div class="symple-player">                    <div class="symple-player-message"></div>                    <div class="symple-player-status"></div>                    <div class="symple-player-loading"></div>                    <div class="symple-player-screen"></div>                    <div class="symple-player-controls">                        <a class="play-btn" rel="play" href="#">Play</a>                        <a class="stop-btn" rel="stop" href="#">Stop</a>                        <a class="fullscreen-btn" rel="fullscreen" href="#">Fullscreen</a>                    </div>                </div>'},b),this.element=$(this.options.element),this.element.hasClass("symple-player")||(this.element.html(this.options.template),this.element=this.element.children(".symple-player:first")),!this.element.length)throw"Player element not found";if(this.screen=this.element.find(".symple-player-screen"),!this.screen.length)throw"Player screen element not found";if(this.message=this.element.find(".symple-player-message"),!this.message.length)throw"Player message element not found";if("undefined"==typeof this.options.engine){var c=a.Media.preferredCompatibleEngine(this.options.format);c&&(this.options.engine=c.id)}this.bindEvents(),this.playing=!1},setup:function(){var b=this.options.engine;if(!b)throw"Streaming engine not configured. Please set 'options.engine'";if(!a.Media.hasEngine(b))throw"Streaming engine not available: "+b;if("undefined"==typeof a.Player.Engine[b])throw"Streaming engine not found: "+b;if(!a.Media.supportsEngine(b))throw"Streaming engine not supported: "+b;this.engine=new a.Player.Engine[b](this),this.engine.setup(),this.element.addClass("engine-"+b.toLowerCase())},play:function(b){a.log("symple:player: play",b);try{this.engine||this.setup(),"playing"!=this.state&&(this.setState("loading"),this.engine.play(b))}catch(c){throw this.setState("error"),this.displayMessage("error",c),c}},stop:function(){a.log("symple:player: stop"),"stopped"!=this.state&&this.engine&&this.engine.stop()},destroy:function(){this.engine&&this.engine.destroy(),this.element.remove()},mute:function(b){b=!!b,a.log("symple:player: mute",b),this.engine&&this.engine.mute&&this.engine.mute(b),this.element[b?"addClass":"removeClass"]("muted")},setState:function(b,c){a.log("symple:player: set state",this.state,"=>",b),this.state!=b&&(this.state=b,this.displayStatus(null),this.playing="playing"==b,c?this.displayMessage("error"==b?"error":"info",c):this.displayMessage(null),this.element.removeClass("state-stopped state-loading state-playing state-paused state-error"),this.element.addClass("state-"+b),this.options.onStateChange(this,b,c))},displayStatus:function(a){this.element.find(".symple-player-status").html(a?a:"")},displayMessage:function(b,c){a.log("symple:player: display message",b,c),c?this.message.html('<p class="'+b+'-message">'+c+"</p>").show():this.message.html("").hide()},bindEvents:function(){var a=this;this.element.find(".symple-player-controls a").unbind().bind("click tap",function(){return a.sendCommand(this.rel,$(this)),!1})},sendCommand:function(a,b){if(!this.options.onCommand||!this.options.onCommand(this,a,b))switch(a){case"play":this.play();break;case"stop":this.stop();break;case"mute":this.mute(!0);break;case"unmute":this.mute(!1);break;case"fullscreen":this.toggleFullScreen()}},getButton:function(a){return this.element.find('.symple-player-controls [rel="'+a+'"]')},toggleFullScreen:function(){var b=$(this.options.fullscreenElement)[0]||this.element[0];console.log(b),a.runVendorMethod(document,"FullScreen")||a.runVendorMethod(document,"IsFullScreen")?a.runVendorMethod(document,"CancelFullScreen"):a.runVendorMethod(b,"RequestFullScreen")}}),a.Player.Engine=a.Class.extend({init:function(a){this.player=a,this.fps=0,this.seq=0},support:function(){return!0},setup:function(){},destroy:function(){},play:function(a){this.params=a||{},this.params.url||"object"!=typeof a.address||(this.params.url=this.buildURL())},stop:function(){},pause:function(){},mute:function(){},setState:function(a,b){this.player.setState(a,b)},setError:function(b){a.log("symple:player:engine: error",b),this.setState("error",b)},onRemoteCandidate:function(){a.log("symple:player:engine: remote candidates not supported.")},updateFPS:function(){if("undefined"==typeof this.prevTime&&(this.prevTime=(new Date).getTime()),this.seq>0){var a=(new Date).getTime();this.delta=this.prevTime?a-this.prevTime:0,this.fps=(1e3/this.delta).toFixed(3),this.prevTime=a}this.seq++},displayFPS:function(){this.updateFPS(),this.player.displayStatus(this.delta+" ms ("+this.fps+" fps)")},buildURL:function(){if(!this.params)throw"Streaming parameters not set";return this.params.address||(this.params.address=this.player.options.address),a.Media.buildURL(this.params)}})}(window.Symple=window.Symple||{}),function(a){window.RTCPeerConnection=window.mozRTCPeerConnection||window.webkitRTCPeerConnection,window.RTCSessionDescription=window.mozRTCSessionDescription||window.RTCSessionDescription,window.RTCIceCandidate=window.mozRTCIceCandidate||window.RTCIceCandidate,window.URL=window.webkitURL||window.URL,navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,a.Media.registerEngine({id:"WebRTC",name:"WebRTC Player",formats:"VP9, VP4, H.264, Opus",preference:100,support:function(){return"undefined"!=typeof RTCPeerConnection}()}),a.Player.Engine.WebRTC=a.Player.Engine.extend({init:function(b){a.log("symple:webrtc: init"),this._super(b),this.rtcConfig=b.options.rtcConfig||{iceServers:[{url:"stun:stun.l.google.com:19302"}]},this.rtcOptions=b.options.rtcOptions||{optional:[{DtlsSrtpKeyAgreement:!0}]},this.initiator=b.options.initiator,this.userMediaConstraints=b.options.userMediaConstraints||{audio:!0,video:!0},this.activeStream=null},setup:function(){a.log("symple:webrtc: setup"),this._createPeerConnection(),"undefined"==typeof this.video&&(this.video=document.createElement("video"),this.video.autoplay=!0,this.player.screen.prepend(this.video))},destroy:function(){a.log("symple:webrtc: destroy"),this.sendLocalSDP=null,this.sendLocalCandidate=null,this.activeStream=null,this.video&&(this.video.src="",this.video=null),this.pc&&(this.pc.close(),this.pc=null)},play:function(b){if(a.log("symple:webrtc: play",b),this.activeStream)this.video.src=URL.createObjectURL(this.activeStream),this.video.play(),this.setState("playing");else if(this.initiator){a.log("symple:webrtc: initiating",this.userMediaConstraints);var c=this;navigator.getUserMedia(this.userMediaConstraints,function(b){c.video.src=URL.createObjectURL(b),c.pc.addStream(b),c.pc.createOffer(function(b){a.log("symple:webrtc: offer",b),c._onLocalSDP(b)},function(b){a.log("symple:webrtc: offer failed",b)}),c.activeStream=b},function(a){c.setError("getUserMedia() failed: "+a)})}},stop:function(){this.video&&(this.video.src=""),this.setState("stopped")},mute:function(b){b=b===!1?!1:!0,a.log("symple:webrtc: mute",b),this.video&&this.video.prop("muted",b)},sendLocalSDP:null,sendLocalCandidate:null,recvRemoteSDP:function(b){if(a.log("symple:webrtc: recv remote sdp",b),!b||!b.type||!b.sdp)throw"Invalid remote SDP";var c=this;this.pc.setRemoteDescription(new RTCSessionDescription(b),function(){a.log("symple:webrtc: sdp success")},function(a){console.error("symple:webrtc: sdp error",a),c.setError("Cannot parse remote SDP offer")}),"offer"==b.type&&c.pc.createAnswer(function(a){c._onLocalSDP(a)},function(){c.setError("Cannot create local SDP answer")},null)},recvRemoteCandidate:function(b){if(a.log("symple:webrtc: recv remote candiate",b),!this.pc)throw"The peer connection is not initialized";this.pc.addIceCandidate(new RTCIceCandidate(b))},_onLocalSDP:function(b){try{this.pc.setLocalDescription(b),this.sendLocalSDP(b)}catch(c){a.log("symple:webrtc: failed to send local SDP",c)}},_createPeerConnection:function(){if(this.pc)throw"The peer connection is already initialized";a.log("symple:webrtc: create peer connnection",this.rtcConfig,this.rtcOptions);var b=this;this.pc=new RTCPeerConnection(this.rtcConfig,this.rtcOptions),this.pc.onicecandidate=function(c){c.candidate?(a.log("symple:webrtc: candidate gathered",c.candidate),b.sendLocalCandidate(c.candidate)):a.log("symple:webrtc: candidate gathering complete")},this.pc.onaddstream=function(c){a.log("symple:webrtc: remote stream added",URL.createObjectURL(c.stream)),b.setState("playing"),b.video.src=URL.createObjectURL(c.stream),b.video.play(),b.activeStream=c.stream},this.pc.onremovestream=function(c){a.log("symple:webrtc: remote stream removed",c),b.video.stop(),b.video.src=""}}}),a.Media.iceCandidateType=function(a){return-1!=a.indexOf("typ relay")?"turn":-1!=a.indexOf("typ srflx")?"stun":-1!=a.indexOf("typ host")?"host":"unknown"}}(window.Symple=window.Symple||{});